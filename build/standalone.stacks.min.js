(function(k){var l;k.stacks={};k.stacks.sync=function(g){return function(c,e){e(g.call(this,c))}};k.stacks.serial=function(){var g,c,e,j,f;g=function(a){if(a.steps.length==0)a.clb&&a.clb.call(this,a.ctx);else{var b=a.steps.shift(),h=l(this,a,function(d){if(d.pass)d.steps=[];g.call(this,d)});b.call(this,a.ctx,h)}};c=function(a){var b=function(h,d){f.call(this,arguments.callee.state,h,d)};b.state={steps:[]};b.toString=e;b.push=j;for(i in a.steps)b.state.steps[i]=a.steps[i];return b};f=function(a,b,
h){b={steps:[],ctx:b,clb:h};for(var d in a.steps)b.steps[d]=a.steps[d];g.call(this,b)};e=function(){return"serial:["+this.state.steps.toString()+"]"};j=function(a){var b=c(this.state);b.state.steps.push(a);return b};return function(a){return c({steps:a})}}();k.stacks.parallel=function(){var g,c,e,j,f;g=function(a,b){var h=l(this,b,function(d){d.length-=1;d.length==0&&d.clb&&d.clb.call(this,d.ctx)});a.call(this,b.ctx,h)};c=function(a){var b=function(h,d){f.call(this,arguments.callee.state,h,d)};b.state=
{steps:[]};b.toString=e;b.push=j;for(i in a.steps)b.state.steps[i]=a.steps[i];return b};f=function(a,b,h){b={steps:{},ctx:b,clb:h};var d;b.length=a.steps.length;for(d in a.steps)b.steps[d]=a.steps[d];for(d in b.steps)g.call(this,b.steps[d],b)};e=function(){return"parallel:["+this.state.steps.toString()+"]"};j=function(a){var b=c(this.state);b.state.steps.push(a);return b};return function(a){return c({steps:a})}}();k.stacks.cascade=function(){var g,c,e,j,f;f=function(a){if(a.done)a.clb&&a.clb.call(this,
a.ctx);else if(a.steps.length==0)a.clb&&a.clb.pass&&a.clb.pass(a.ctx);else{var b=a.steps.shift(),h=l(this,a,function(d){if(!d.pass)d.done=true;f.call(this,d)});b.call(this,a.ctx,h)}};g=function(a){var b=function(h,d){j.call(this,arguments.callee.state,h,d)};b.state={steps:[]};b.toString=c;b.push=e;for(i in a.steps)b.state.steps[i]=a.steps[i];return b};j=function(a,b,h){b={steps:[],ctx:b,clb:h,done:false};for(var d in a.steps)b.steps[d]=a.steps[d];f.call(this,b)};c=function(){return"cascade:["+this.state.steps.toString()+
"]"};e=function(a,b){if(b){this.state.steps.push(a);return this}else{var h=g(this.state);h.state.steps.push(a);return h}};return function(a){return g({steps:a})}}();k.stacks.image=function(g,c){c||(c="images");return function(e,j){var f=new Image;f.onload=function(){e[c]||(e[c]=[]);f.status="success";e[c].push(f);j(e)};f.onerror=function(){e[c]||(e[c]=[]);f.status="error";e[c].push(f);j(e)};f.onabort=function(){e[c]||(e[c]=[]);f.status="abort";e[c].push(f);j(e)};f.src=g}};k.stacks.images=function(g,
c){var e,j=[];for(e in g)j.push(k.stacks.image(g[e],c));return k.stacks.parallel(j)};l=function(g,c,e){var j=function(f){c.ctx=f||c.ctx;c.pass=false;e.call(g,c)};j.pass=function(f){c.ctx=f||c.ctx;c.pass=true;c.clb&&c.clb.pass?c.clb.pass(c.ctx):e.call(g,c)};return j}})(this);
