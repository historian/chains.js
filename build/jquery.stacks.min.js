(function(j){var l;j.stacks={};j.stacks.sync=function(e){return function(b,d){d(e.call(this,b))}};j.stacks.serial=function(){var e,b,d,g,f;e=function(a){if(a.steps.length==0)a.clb&&a.clb.call(this,a.ctx);else{var c=a.steps.shift(),k=l(this,a,function(h){if(h.pass)h.steps=[];e.call(this,h)});c.call(this,a.ctx,k)}};b=function(a){var c=function(k,h){f.call(this,arguments.callee.state,k,h)};c.state={steps:[]};c.toString=d;c.push=g;for(i in a.steps)c.state.steps[i]=a.steps[i];return c};f=function(a,c,
k){c={steps:[],ctx:c,clb:k};for(var h in a.steps)c.steps[h]=a.steps[h];e.call(this,c)};d=function(){return"serial:["+this.state.steps.toString()+"]"};g=function(a){var c=b(this.state);c.state.steps.push(a);return c};return function(a){return b({steps:a})}}();j.stacks.parallel=function(){var e,b,d,g,f;e=function(a,c){var k=l(this,c,function(h){h.length-=1;h.length==0&&h.clb&&h.clb.call(this,h.ctx)});a.call(this,c.ctx,k)};b=function(a){var c=function(k,h){f.call(this,arguments.callee.state,k,h)};c.state=
{steps:[]};c.toString=d;c.push=g;for(i in a.steps)c.state.steps[i]=a.steps[i];return c};f=function(a,c,k){c={steps:{},ctx:c,clb:k};var h;c.length=a.steps.length;for(h in a.steps)c.steps[h]=a.steps[h];for(h in c.steps)e.call(this,c.steps[h],c)};d=function(){return"parallel:["+this.state.steps.toString()+"]"};g=function(a){var c=b(this.state);c.state.steps.push(a);return c};return function(a){return b({steps:a})}}();j.stacks.cascade=function(){var e,b,d,g,f;f=function(a){if(a.done)a.clb&&a.clb.call(this,
a.ctx);else if(a.steps.length==0)a.clb&&a.clb.pass&&a.clb.pass(a.ctx);else{var c=a.steps.shift(),k=l(this,a,function(h){if(!h.pass)h.done=true;f.call(this,h)});c.call(this,a.ctx,k)}};e=function(a){var c=function(k,h){g.call(this,arguments.callee.state,k,h)};c.state={steps:[]};c.toString=b;c.push=d;for(i in a.steps)c.state.steps[i]=a.steps[i];return c};g=function(a,c,k){c={steps:[],ctx:c,clb:k,done:false};for(var h in a.steps)c.steps[h]=a.steps[h];f.call(this,c)};b=function(){return"cascade:["+this.state.steps.toString()+
"]"};d=function(a,c){if(c){this.state.steps.push(a);return this}else{var k=e(this.state);k.state.steps.push(a);return k}};return function(a){return e({steps:a})}}();j.stacks.image=function(e,b){b||(b="images");return function(d,g){var f=new Image;f.onload=function(){d[b]||(d[b]=[]);f.status="success";d[b].push(f);g(d)};f.onerror=function(){d[b]||(d[b]=[]);f.status="error";d[b].push(f);g(d)};f.onabort=function(){d[b]||(d[b]=[]);f.status="abort";d[b].push(f);g(d)};f.src=e}};j.stacks.images=function(e,
b){var d,g=[];for(d in e)g.push(j.stacks.image(e[d],b));return j.stacks.parallel(g)};j.stacks.ajax=function(e){var b=e.key||"response";delete e.key;return function(d,g){j.extend(e,{success:function(f,a,c){d[b]={success:true,data:f,textStatus:a,XMLHttpRequest:c};g(d)},error:function(f,a,c){d[b]={success:false,errorThrown:c,textStatus:a,XMLHttpRequest:f};g(d)}});j.ajax(e)}};j.stacks.batch_ajax=function(e){var b,d,g=[];for(b in e){d=e[b];d.key=b;g.push(j.stacks.ajax(d))}return j.stacks.parallel(g)};
j.stacks.preload_image=function(e,b){b||(b="data-src");return function(d,g){var f=j(e).attr(b);e.onload=function(){e.status="success";g(d)};e.onerror=function(){e.status="error";g(d)};e.onabort=function(){e.status="abort";g(d)};e.src=f}};j.stacks.preload_images=function(e,b,d){b||(b="data-src");var g=[],f;j(e).find("img.+src_attr+").each(function(){f=j.stacks.preload_image(this,b);if(d)f=j.stacks.serial([f,d]);g.push(f)});return j.stacks.parallel(g)};l=function(e,b,d){var g=function(f){b.ctx=f||b.ctx;
b.pass=false;d.call(e,b)};g.pass=function(f){b.ctx=f||b.ctx;b.pass=true;b.clb&&b.clb.pass?b.clb.pass(b.ctx):d.call(e,b)};return g}})(jQuery);
